<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogicBro - Audio Analysis Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="logo">
                <i class="mdi mdi-music-note"></i>
                LogicBro
            </a>
            <div class="nav-links">
                <a href="/dashboard" class="nav-link active">
                    <i class="mdi mdi-view-dashboard"></i>
                    Dashboard
                </a>
                <a href="/projects" class="nav-link">
                    <i class="mdi mdi-folder-music"></i>
                    Projects
                </a>
                <a href="/profile" class="nav-link">
                    <i class="mdi mdi-account"></i>
                    Profile
                </a>
                <form th:action="@{/logout}" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-outline btn-sm">
                        <i class="mdi mdi-logout"></i>
                        Logout
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Welcome Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h1 class="card-title">
                    <i class="mdi mdi-waveform"></i>
                    Welcome back, <span th:text="${username}">User</span>!
                </h1>
                <p class="card-subtitle">Start analyzing your audio files or continue working on your projects</p>
            </div>
        </div>

        <!-- Audio Analysis Section -->
        <div class="card mb-5">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="mdi mdi-music-circle"></i>
                    Audio Analysis
                </h2>
                <p class="card-subtitle">Upload and analyze your audio files with advanced AI-powered tools</p>
            </div>
            
            <div class="upload-area" id="dropZone">
                <i class="mdi mdi-cloud-upload upload-icon"></i>
                <h3>Drag and drop your audio file here</h3>
                <p class="text-secondary">or click to browse your files</p>
                <input type="file" id="fileInput" accept="audio/*" style="display: none;">
                <button class="btn btn-primary btn-lg" onclick="document.getElementById('fileInput').click()">
                    <i class="mdi mdi-file-music"></i>
                    Select Audio File
                </button>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="mdi mdi-information"></i>
                        Supported formats: MP3, WAV, OGG, AAC, M4A (Max size: 50MB)
                    </small>
                </div>
            </div>
            
            <div id="uploadProgress" class="hidden mt-4">
                <div class="progress-bar">
                    <div class="progress" style="width: 0%"></div>
                </div>
                <p id="uploadStatus" class="text-center mt-2">Uploading...</p>
            </div>
        </div>

        <!-- Analysis Results Section -->
        <div id="analysisResults" class="hidden">
            <div class="card-header mb-4">
                <h2 class="card-title">
                    <i class="mdi mdi-chart-line"></i>
                    Analysis Results
                </h2>
            </div>
            
            <div class="analysis-results">
                <!-- Waveform Card -->
                <div class="result-card">
                    <h3>
                        <i class="mdi mdi-waveform"></i>
                        Waveform Visualization
                    </h3>
                    <div class="waveform" id="waveform"></div>
                    <div class="controls">
                        <button class="btn btn-primary" id="playBtn" disabled>
                            <i class="mdi mdi-play"></i>
                            Play
                        </button>
                        <button class="btn btn-secondary" id="stopBtn" disabled>
                            <i class="mdi mdi-stop"></i>
                            Stop
                        </button>
                        <button class="btn btn-outline" id="downloadBtn">
                            <i class="mdi mdi-download"></i>
                            Download
                        </button>
                    </div>
                </div>

                <!-- Key & Scale Card -->
                <div class="result-card">
                    <h3>
                        <i class="mdi mdi-piano"></i>
                        Key & Scale Analysis
                    </h3>
                    <div class="visualization" id="keyVisual"></div>
                    <div class="flex gap-2 mt-3">
                        <div class="chip" id="keyChip">Key: --</div>
                        <div class="chip" id="scaleChip">Scale: --</div>
                    </div>
                </div>

                <!-- Chord Progression Card -->
                <div class="result-card">
                    <h3>
                        <i class="mdi mdi-guitar-acoustic"></i>
                        Chord Progression
                    </h3>
                    <div class="visualization" id="chordVisual"></div>
                    <div class="chip-sequence" id="chordSequence">
                        <!-- Chord chips will be populated here -->
                    </div>
                    <div class="controls mt-4">
                        <button class="btn btn-secondary" id="generateVariation">
                            <i class="mdi mdi-auto-fix"></i>
                            Generate Variation
                        </button>
                        <button class="btn btn-outline">
                            <i class="mdi mdi-content-copy"></i>
                            Copy Progression
                        </button>
                    </div>
                </div>

                <!-- Melodic Patterns Card -->
                <div class="result-card">
                    <h3>
                        <i class="mdi mdi-music-note-eighth"></i>
                        Melodic Patterns
                    </h3>
                    <div class="visualization" id="melodyVisual"></div>
                    <div class="chip-sequence" id="melodyPatterns">
                        <!-- Melody pattern chips will be populated here -->
                    </div>
                </div>

                <!-- Tempo & Timing Card -->
                <div class="result-card">
                    <h3>
                        <i class="mdi mdi-metronome"></i>
                        Tempo & Timing
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-primary" id="tempoValue">-- BPM</div>
                            <div class="text-sm text-secondary">Tempo</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-primary" id="timeSignature">--/--</div>
                            <div class="text-sm text-secondary">Time Signature</div>
                        </div>
                    </div>
                </div>

                <!-- Audio Separation Card -->
                <div class="result-card">
                    <h3>
                        <i class="mdi mdi-track-light"></i>
                        Track Separation
                    </h3>
                    <div class="text-center mb-3">
                        <button class="btn btn-primary" id="separateTracksBtn">
                            <i class="mdi mdi-call-split"></i>
                            Separate Audio Tracks
                        </button>
                    </div>
                    <div id="separatedTracks" class="hidden">
                        <!-- Separated track controls will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Section -->
        <div class="card mt-5">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="mdi mdi-folder-multiple"></i>
                    Your Projects
                </h2>
                <p class="card-subtitle">Continue working on your saved projects or create a new one</p>
            </div>
            
            <div class="project-list" th:if="${not #lists.isEmpty(projects)}">
                <div th:each="project : ${projects}" class="project-card">
                    <h3 th:text="${project.projectName}">Project Name</h3>
                    <p class="text-secondary" th:text="'Created: ' + ${#temporals.format(project.createdAt, 'MMM dd, yyyy')}">Created: Jan 01, 2024</p>
                    <p class="text-muted" th:text="${project.description}" th:if="${project.description}">Project description</p>
                    <div class="controls mt-4">
                        <a th:href="@{/projects/{id}(id=${project.id})}" class="btn btn-primary">
                            <i class="mdi mdi-folder-open"></i>
                            Open Project
                        </a>
                        <button class="btn btn-outline" th:onclick="'editProject(' + ${project.id} + ')'">
                            <i class="mdi mdi-pencil"></i>
                            Edit
                        </button>
                        <button class="btn btn-ghost text-error" th:onclick="'deleteProject(' + ${project.id} + ')'">
                            <i class="mdi mdi-delete"></i>
                            Delete
                        </button>
                    </div>
                </div>
            </div>
            
            <div th:if="${#lists.isEmpty(projects)}" class="text-center py-5">
                <i class="mdi mdi-folder-plus text-6xl text-muted mb-3"></i>
                <h3 class="text-muted">No projects yet</h3>
                <p class="text-secondary">Start by uploading an audio file to create your first project!</p>
                <button class="btn btn-primary mt-3" onclick="document.getElementById('fileInput').click()">
                    <i class="mdi mdi-plus"></i>
                    Create First Project
                </button>
            </div>
        </div>
    </div>
                    <button class="btn btn-outline" id="playBtn">
                        <i class="mdi mdi-play"></i> Play
                    </button>
                    <button class="btn btn-outline" id="stopBtn">
                        <i class="mdi mdi-stop"></i> Stop
                    </button>
                </div>
            </div>

            <div class="result-card">
                <h3>Key and Scale</h3>
                <div class="visualization" id="keyVisual"></div>
                <div id="keyInfo">
                    <div class="chip" id="keyChip">Key: C</div>
                    <div class="chip" id="scaleChip">Scale: Major</div>
                </div>
            </div>

            <div class="result-card">
                <h3>Chord Progression</h3>
                <div class="visualization" id="chordVisual"></div>
                <div id="chordSequence"></div>
                <div class="controls">
                    <button class="btn btn-primary" id="generateVariation">
                        Generate Variation
                    </button>
                </div>
            </div>

            <div class="result-card">
                <h3>Melodic Patterns</h3>
                <div class="visualization" id="melodyVisual"></div>
                <div id="melodyPatterns"></div>
            </div>
        </div>

        <!-- Project List -->
        <div class="card">
            <h2>Your Projects</h2>
            <div class="project-list">
                <div th:each="project : ${projects}" class="result-card">
                    <h3 th:text="${project.projectName}"></h3>
                    <p th:text="'Created: ' + ${project.createdAt}"></p>
                    <div class="controls">
                        <a th:href="@{/projects/{id}(id=${project.id})}" class="btn btn-primary">Open</a>
                        <button class="btn btn-outline" th:onclick="'deleteProject(' + ${project.id} + ')'">Delete</button>
                    </div>
                </div>
                <div th:if="${#lists.isEmpty(projects)}">
                    <p class="text-secondary">No projects yet. Start by uploading an audio file!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for variations -->
    <div id="variationModal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="closeModal('variationModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate Variation</h3>
                <button class="btn btn-ghost btn-sm" onclick="closeModal('variationModal')">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Variation Amount</label>
                    <input type="range" class="form-control" id="variationAmount" min="0" max="100" value="50">
                    <div class="form-help">Adjust how different the variation should be</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Style</label>
                    <select class="form-control" id="variationStyle">
                        <option value="similar">Similar</option>
                        <option value="contrast">Contrasting</option>
                        <option value="experimental">Experimental</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('variationModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" id="generateBtn">
                    <i class="mdi mdi-auto-fix"></i>
                    Generate
                </button>
            </div>
        </div>
    </div>

    <!-- Toast notifications container -->
    <div id="toastContainer" class="toast-container"></div>

    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/common.js}"></script>
    <script th:src="@{/js/visualizations.js}"></script>
    <script th:src="@{/js/dashboard.js}"></script>
    
    <script>
        // Global functions for template usage
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project?')) {
                fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        showToast('Error deleting project', 'error');
                    }
                });
            }
        }
    </script>
</body>
</html>